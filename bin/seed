#!/bin/bash

# Seed Script - Uses API calls to populate test data
# This validates API endpoints while seeding

set -e

# Ensure UTF-8 encoding
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

API_BASE="${API_BASE:-http://localhost:8080/api}"

echo "ğŸŒ± Starting API-based seeding..."
echo "   API Base: $API_BASE"
echo ""

# Check API health
echo "ğŸ” Checking API health..."
HEALTH=$(curl -s "$API_BASE/../health" || echo "")
if [ -z "$HEALTH" ]; then
    echo "âŒ API is not running. Please start the backend first."
    exit 1
fi
echo "âœ“ API is healthy"
echo ""

# Helper function to perform API requests
# Uses a temporary file for the data body to avoid command-line encoding issues on Windows
api_request() {
    local method=$1
    local endpoint=$2
    local token=$3
    local data=$4
    
    local tmp_file
    tmp_file=$(mktemp)
    
    # Write data to temporary file
    # printf avoids some echo inconsistencies
    printf "%s" "$data" > "$tmp_file"
    
    local auth_args=()
    if [ -n "$token" ]; then
        auth_args=(-H "Authorization: Bearer $token")
    fi
    
    # Execute curl reading from the file (@$tmp_file)
    curl -s -X "$method" "$API_BASE$endpoint" \
        -H "Content-Type: application/json; charset=utf-8" \
        "${auth_args[@]}" \
        -d @"$tmp_file"
        
    rm -f "$tmp_file"
}

# ===== 1. Register User =====
echo "ğŸ‘¤ Registering user: dev..."
REGISTER_RESULT=$(api_request POST "/users/register" "" '{"username":"dev","password":"dev123","display_name":"Developer"}')

# Check if user already exists (conflict error)
if echo "$REGISTER_RESULT" | grep -q "already exists"; then
    echo "   User 'dev' already exists, logging in instead..."
    LOGIN_RESULT=$(api_request POST "/users/login" "" '{"username":"dev","password":"dev123"}')
    TOKEN=$(echo "$LOGIN_RESULT" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
else
    TOKEN=$(echo "$REGISTER_RESULT" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
fi

if [ -z "$TOKEN" ]; then
    echo "âŒ Failed to get auth token"
    echo "   Response: $REGISTER_RESULT"
    exit 1
fi
echo "âœ“ Authenticated"
echo ""

# ===== 2. Create Personal Ledger =====
echo "ğŸ“’ Creating personal ledger: æˆ‘çš„å¸³æœ¬..."
LEDGER_RESULT=$(api_request POST "/ledgers" "$TOKEN" '{"name":"æˆ‘çš„å¸³æœ¬","type":"personal","currencies":["TWD","JPY","USD"],"categories":["é£Ÿç‰©","äº¤é€š","è³¼ç‰©","å¨›æ¨‚"],"payment_methods":["ç¾é‡‘","ä¿¡ç”¨å¡","Line Pay"]}')

LEDGER_ID=$(echo "$LEDGER_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
if [ -z "$LEDGER_ID" ]; then
    echo "âš ï¸  Ledger creation failed"
    echo "   Response: $LEDGER_RESULT"
else
    echo "âœ“ Created ledger: $LEDGER_ID"
    
    # ===== 3. Create Sample Transactions =====
    echo "ğŸ’° Creating sample transactions..."
    
    # Transaction 1: åˆé¤
    api_request POST "/ledgers/$LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"TWD","exchange_rate":1,"category":"é£Ÿç‰©","payment_method":"ç¾é‡‘","note":"åˆé¤","items":[{"name":"åˆé¤","unit_price":150,"quantity":1}]}' > /dev/null
    echo "   âœ“ åˆé¤ - TWD 150"
    
    # Transaction 2: æ·é‹
    api_request POST "/ledgers/$LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"TWD","exchange_rate":1,"category":"äº¤é€š","payment_method":"æ‚ éŠå¡","note":"æ·é‹","items":[{"name":"æ·é‹","unit_price":35,"quantity":1}]}' > /dev/null
    echo "   âœ“ æ·é‹ - TWD 35"
    
    # Transaction 3: ç”Ÿæ´»ç”¨å“
    api_request POST "/ledgers/$LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"TWD","exchange_rate":1,"category":"è³¼ç‰©","payment_method":"ä¿¡ç”¨å¡","note":"ç”Ÿæ´»ç”¨å“","items":[{"name":"ç”Ÿæ´»ç”¨å“","unit_price":299,"quantity":1}]}' > /dev/null
    echo "   âœ“ ç”Ÿæ´»ç”¨å“ - TWD 299"
fi
echo ""

# ===== 4. Create Trip =====
echo "âœˆï¸  Creating trip: 2024 æ—¥æœ¬æ—…è¡Œ..."
TRIP_RESULT=$(api_request POST "/trips" "$TOKEN" '{"name":"2024 æ—¥æœ¬æ—…è¡Œ","description":"æ±äº¬ + å¤§é˜ª 5å¤©4å¤œ","base_currency":"JPY","members":["å°æ˜","å°ç¾"]}')

TRIP_ID=$(echo "$TRIP_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
TRIP_LEDGER_ID=$(echo "$TRIP_RESULT" | grep -o '"ledger_id":"[^"]*"' | head -1 | cut -d'"' -f4)

if [ -z "$TRIP_ID" ]; then
    echo "âš ï¸  Trip creation failed"
    echo "   Response: $TRIP_RESULT"
else
    echo "âœ“ Created trip: $TRIP_ID (ledger: $TRIP_LEDGER_ID)"
    
    # ===== 5. Update Trip Ledger Settings =====
    echo "ğŸ“‹ Updating trip settings..."
    api_request PUT "/trips/$TRIP_ID" "$TOKEN" '{"currencies":["JPY"],"categories":["ä½å®¿","äº¤é€š","é£²é£Ÿ","è³¼ç‰©","é–€ç¥¨"],"payment_methods":["ç¾é‡‘","ä¿¡ç”¨å¡"]}' > /dev/null
    echo "âœ“ Updated trip ledger settings"
    
    # ===== 6. Create Comparison Stores =====
    echo "ğŸª Creating comparison stores..."
    
    STORE1_RESULT=$(api_request POST "/trips/$TRIP_ID/stores" "$TOKEN" '{"name":"å”å‰è»»å¾· æ–°å®¿åº—","location":"æ–°å®¿"}')
    STORE1_ID=$(echo "$STORE1_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    echo "   âœ“ å”å‰è»»å¾· æ–°å®¿åº—"
    
    STORE2_RESULT=$(api_request POST "/trips/$TRIP_ID/stores" "$TOKEN" '{"name":"Bic Camera æœ‰æ¥½ç”º","location":"æœ‰æ¥½ç”º"}')
    STORE2_ID=$(echo "$STORE2_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    echo "   âœ“ Bic Camera æœ‰æ¥½ç”º"
    
    # ===== 7. Create Comparison Products =====
    if [ -n "$STORE1_ID" ] && [ -n "$STORE2_ID" ]; then
        echo "ğŸ“¦ Creating comparison products..."
        
        api_request POST "/trips/$TRIP_ID/stores/$STORE1_ID/products" "$TOKEN" '{"name":"è—¥å¦","price":2980,"currency":"JPY"}' > /dev/null
        echo "   âœ“ è—¥å¦ @ å”å‰è»»å¾· - Â¥2980"
        
        api_request POST "/trips/$TRIP_ID/stores/$STORE1_ID/products" "$TOKEN" '{"name":"é›¶é£Ÿçµ„åˆ","price":1500,"currency":"JPY"}' > /dev/null
        echo "   âœ“ é›¶é£Ÿçµ„åˆ @ å”å‰è»»å¾· - Â¥1500"
        
        api_request POST "/trips/$TRIP_ID/stores/$STORE2_ID/products" "$TOKEN" '{"name":"è—¥å¦","price":3200,"currency":"JPY"}' > /dev/null
        echo "   âœ“ è—¥å¦ @ Bic Camera - Â¥3200"
    fi
    
    # ===== 8. Create Trip Ledger Transactions =====
    if [ -n "$TRIP_LEDGER_ID" ]; then
        echo "ğŸ’´ Creating trip transactions..."
        
        # Transaction 1: é£¯åº—
        api_request POST "/ledgers/$TRIP_LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"JPY","exchange_rate":0.22,"category":"ä½å®¿","payment_method":"ä¿¡ç”¨å¡","note":"æ±äº¬é£¯åº— 2æ™š","items":[{"name":"æ±äº¬é£¯åº—","unit_price":28000,"quantity":2}]}' > /dev/null
        echo "   âœ“ æ±äº¬é£¯åº— - Â¥56,000"
        
        # Transaction 2: æ‹‰éºµ
        api_request POST "/ledgers/$TRIP_LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"JPY","exchange_rate":0.22,"category":"é£²é£Ÿ","payment_method":"ç¾é‡‘","note":"ä¸€è˜­æ‹‰éºµ","items":[{"name":"ä¸€è˜­æ‹‰éºµ","unit_price":980,"quantity":3}]}' > /dev/null
        echo "   âœ“ ä¸€è˜­æ‹‰éºµ x3 - Â¥2,940"
        
        # Transaction 3: åœ°éµ
        api_request POST "/ledgers/$TRIP_LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"JPY","exchange_rate":0.22,"category":"äº¤é€š","payment_method":"ç¾é‡‘","note":"æ±äº¬åœ°éµä¸€æ—¥åˆ¸","items":[{"name":"åœ°éµä¸€æ—¥åˆ¸","unit_price":800,"quantity":3}]}' > /dev/null
        echo "   âœ“ åœ°éµä¸€æ—¥åˆ¸ x3 - Â¥2,400"
        
        # Transaction 4: è¿ªå£«å°¼é–€ç¥¨
        api_request POST "/ledgers/$TRIP_LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"JPY","exchange_rate":0.22,"category":"é–€ç¥¨","payment_method":"ä¿¡ç”¨å¡","note":"æ±äº¬è¿ªå£«å°¼é–€ç¥¨","items":[{"name":"è¿ªå£«å°¼é–€ç¥¨","unit_price":8400,"quantity":3}]}' > /dev/null
        echo "   âœ“ è¿ªå£«å°¼é–€ç¥¨ x3 - Â¥25,200"
        
        # Transaction 5: ä¼´æ‰‹ç¦®
        api_request POST "/ledgers/$TRIP_LEDGER_ID/transactions" "$TOKEN" '{"payer":"Me","currency":"JPY","exchange_rate":0.22,"category":"è³¼ç‰©","payment_method":"ç¾é‡‘","note":"ä¼´æ‰‹ç¦®","items":[{"name":"ç™½è‰²æˆ€äºº","unit_price":1200,"quantity":2},{"name":"æ±äº¬èŠ­å¨œå¨œ","unit_price":1080,"quantity":1}]}' > /dev/null
        echo "   âœ“ ä¼´æ‰‹ç¦® - Â¥3,480"
    fi
fi

echo ""
echo "ğŸ‰ Seed completed!"
echo ""
echo "ğŸ“ Test account:"
echo "   Username: dev"
echo "   Password: dev123"
