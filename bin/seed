#!/bin/bash

# Seed Script - Uses API calls to populate test data
# This validates API endpoints while seeding

set -e

API_BASE="${API_BASE:-http://localhost:8080/api}"

echo "ğŸŒ± Starting API-based seeding..."
echo "   API Base: $API_BASE"
echo ""

# Helper function to make API calls
api_call() {
    local method=$1
    local endpoint=$2
    local data=$3
    local token=$4
    
    local auth_header=""
    if [ -n "$token" ]; then
        auth_header="-H \"Authorization: Bearer $token\""
    fi
    
    if [ -n "$data" ]; then
        eval curl -s -X "$method" "$API_BASE$endpoint" \
            -H "Content-Type: application/json" \
            $auth_header \
            -d "'$data'"
    else
        eval curl -s -X "$method" "$API_BASE$endpoint" \
            -H "Content-Type: application/json" \
            $auth_header
    fi
}

# Check API health
echo "ğŸ” Checking API health..."
HEALTH=$(curl -s "$API_BASE/../health" || echo "")
if [ -z "$HEALTH" ]; then
    echo "âŒ API is not running. Please start the backend first."
    exit 1
fi
echo "âœ“ API is healthy"
echo ""

# ===== 1. Register User =====
echo "ğŸ‘¤ Registering user: dev..."
REGISTER_RESULT=$(api_call POST "/users/register" '{"username":"dev","password":"dev123","display_name":"Developer"}')

# Check if user already exists (conflict error)
if echo "$REGISTER_RESULT" | grep -q "already exists"; then
    echo "   User 'dev' already exists, logging in instead..."
    LOGIN_RESULT=$(api_call POST "/users/login" '{"username":"dev","password":"dev123"}')
    TOKEN=$(echo "$LOGIN_RESULT" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
else
    TOKEN=$(echo "$REGISTER_RESULT" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
fi

if [ -z "$TOKEN" ]; then
    echo "âŒ Failed to get auth token"
    echo "   Response: $REGISTER_RESULT"
    exit 1
fi
echo "âœ“ Authenticated"
echo ""

# ===== 2. Create Personal Ledger =====
echo "ğŸ“’ Creating personal ledger: æˆ‘çš„å¸³æœ¬..."
LEDGER_RESULT=$(api_call POST "/ledgers" '{
    "name": "æˆ‘çš„å¸³æœ¬",
    "type": "personal",
    "currencies": ["TWD", "JPY", "USD"],
    "categories": ["é£Ÿç‰©", "äº¤é€š", "è³¼ç‰©", "å¨›æ¨‚"],
    "payment_methods": ["ç¾é‡‘", "ä¿¡ç”¨å¡", "Line Pay"]
}' "$TOKEN")

LEDGER_ID=$(echo "$LEDGER_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
if [ -z "$LEDGER_ID" ]; then
    echo "âš ï¸  Ledger may already exist or creation failed"
    echo "   Response: $LEDGER_RESULT"
else
    echo "âœ“ Created ledger: $LEDGER_ID"
    
    # ===== 3. Create Sample Transactions =====
    echo "ğŸ’° Creating sample transactions..."
    
    # Transaction 1: åˆé¤
    TXN1=$(api_call POST "/ledgers/$LEDGER_ID/transactions" '{
        "payer": "Me",
        "currency": "TWD",
        "exchange_rate": 1,
        "category": "é£Ÿç‰©",
        "payment_method": "ç¾é‡‘",
        "note": "åˆé¤",
        "items": [{"name": "åˆé¤", "unit_price": 150, "quantity": 1}]
    }' "$TOKEN")
    echo "   âœ“ åˆé¤ - TWD 150"
    
    # Transaction 2: æ·é‹
    TXN2=$(api_call POST "/ledgers/$LEDGER_ID/transactions" '{
        "payer": "Me",
        "currency": "TWD",
        "exchange_rate": 1,
        "category": "äº¤é€š",
        "payment_method": "æ‚ éŠå¡",
        "note": "æ·é‹",
        "items": [{"name": "æ·é‹", "unit_price": 35, "quantity": 1}]
    }' "$TOKEN")
    echo "   âœ“ æ·é‹ - TWD 35"
    
    # Transaction 3: ç”Ÿæ´»ç”¨å“
    TXN3=$(api_call POST "/ledgers/$LEDGER_ID/transactions" '{
        "payer": "Me",
        "currency": "TWD",
        "exchange_rate": 1,
        "category": "è³¼ç‰©",
        "payment_method": "ä¿¡ç”¨å¡",
        "note": "ç”Ÿæ´»ç”¨å“",
        "items": [{"name": "ç”Ÿæ´»ç”¨å“", "unit_price": 299, "quantity": 1}]
    }' "$TOKEN")
    echo "   âœ“ ç”Ÿæ´»ç”¨å“ - TWD 299"
fi
echo ""

# ===== 4. Create Trip =====
echo "âœˆï¸  Creating trip: 2024 æ—¥æœ¬æ—…è¡Œ..."
TRIP_RESULT=$(api_call POST "/trips" '{
    "name": "2024 æ—¥æœ¬æ—…è¡Œ",
    "description": "æ±äº¬ + å¤§é˜ª 5å¤©4å¤œ",
    "base_currency": "JPY",
    "members": ["å°æ˜", "å°ç¾"]
}' "$TOKEN")

TRIP_ID=$(echo "$TRIP_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
TRIP_LEDGER_ID=$(echo "$TRIP_RESULT" | grep -o '"ledger_id":"[^"]*"' | head -1 | cut -d'"' -f4)

if [ -z "$TRIP_ID" ]; then
    echo "âš ï¸  Trip creation may have failed"
    echo "   Response: $TRIP_RESULT"
else
    echo "âœ“ Created trip: $TRIP_ID"
    
    # ===== 5. Update Trip Ledger Settings =====
    if [ -n "$TRIP_LEDGER_ID" ]; then
        echo "ğŸ“‹ Updating trip settings..."
        UPDATE_RESULT=$(api_call PUT "/trips/$TRIP_ID" '{
            "currencies": ["JPY"],
            "categories": ["ä½å®¿", "äº¤é€š", "é£²é£Ÿ", "è³¼ç‰©", "é–€ç¥¨"],
            "payment_methods": ["ç¾é‡‘", "ä¿¡ç”¨å¡"]
        }' "$TOKEN")
        echo "âœ“ Updated trip ledger settings"
    fi
    
    # ===== 6. Create Comparison Stores =====
    echo "ğŸª Creating comparison stores..."
    
    STORE1_RESULT=$(api_call POST "/trips/$TRIP_ID/stores" '{
        "name": "å”å‰è»»å¾· æ–°å®¿åº—",
        "location": "æ–°å®¿"
    }' "$TOKEN")
    STORE1_ID=$(echo "$STORE1_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    echo "   âœ“ å”å‰è»»å¾· æ–°å®¿åº—"
    
    STORE2_RESULT=$(api_call POST "/trips/$TRIP_ID/stores" '{
        "name": "Bic Camera æœ‰æ¥½ç”º",
        "location": "æœ‰æ¥½ç”º"
    }' "$TOKEN")
    STORE2_ID=$(echo "$STORE2_RESULT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    echo "   âœ“ Bic Camera æœ‰æ¥½ç”º"
    
    # ===== 7. Create Comparison Products =====
    if [ -n "$STORE1_ID" ] && [ -n "$STORE2_ID" ]; then
        echo "ğŸ“¦ Creating comparison products..."
        
        api_call POST "/trips/$TRIP_ID/stores/$STORE1_ID/products" '{
            "name": "è—¥å¦",
            "price": 2980,
            "currency": "JPY"
        }' "$TOKEN" > /dev/null
        echo "   âœ“ è—¥å¦ @ å”å‰è»»å¾· - Â¥2980"
        
        api_call POST "/trips/$TRIP_ID/stores/$STORE1_ID/products" '{
            "name": "é›¶é£Ÿçµ„åˆ",
            "price": 1500,
            "currency": "JPY"
        }' "$TOKEN" > /dev/null
        echo "   âœ“ é›¶é£Ÿçµ„åˆ @ å”å‰è»»å¾· - Â¥1500"
        
        api_call POST "/trips/$TRIP_ID/stores/$STORE2_ID/products" '{
            "name": "è—¥å¦",
            "price": 3200,
            "currency": "JPY"
        }' "$TOKEN" > /dev/null
        echo "   âœ“ è—¥å¦ @ Bic Camera - Â¥3200"
    fi
fi

echo ""
echo "ğŸ‰ Seed completed!"
echo ""
echo "ğŸ“ Test account:"
echo "   Username: dev"
echo "   Password: dev123"
