#!/bin/bash

# Refresh Database Script
# Combines: drop database, migration, and seed operations

set -e

# Ensure UTF-8 encoding
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

echo "ğŸ”„ Starting database refresh..."

# Step 1: Stop backend to release DB connections
echo "ğŸ›‘ Stopping backend..."
docker compose stop backend

# Step 2: Drop existing database
echo "ğŸ—‘ï¸  Dropping existing database..."
docker compose exec postgres psql -U postgres -c "DROP DATABASE IF EXISTS lovelion"

# Step 3: Create fresh database
echo "ğŸ“¦ Creating fresh database..."
docker compose exec postgres psql -U postgres -c "CREATE DATABASE lovelion"

# Step 3.5: Clean up R2 Bucket
echo "ğŸ§¹ Cleaning up R2 bucket..."
docker compose run --rm backend go run cmd/cleanup-r2/main.go

# Step 4: Start backend
echo "ğŸš€ Starting backend..."
docker compose start backend

# Wait for backend to be ready
echo "â³ Waiting for backend to be ready..."
sleep 3

# Step 5: Run all migrations
echo "ğŸ“‹ Running migrations..."
docker compose exec backend go run cmd/migrate/main.go

# Step 6: Seed test data via API
# echo "ğŸŒ± Seeding test data via API..."
# SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# "$SCRIPT_DIR/seed"

echo "ğŸŒ± Seeding test data via Go seeder..."
docker compose exec backend go run cmd/seed/main.go

echo ""
echo "âœ… Database refresh complete!"
echo ""
echo "ğŸ“ Test account:"
echo "   Username: dev"
echo "   Password: dev123"
